name: Gateway Smoke Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # hourly

jobs:
  smoke:
    concurrency:
      group: smoke-gateway
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run gateway smoke test
        env:
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
          GATEWAY_TOKEN: ${{ secrets.GATEWAY_TOKEN }}
        run: |
          python tests/openai_gateway_smoke.py

      - name: Upload smoke report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-openai-gateway-report
          path: tests/smoke_openai_gateway_*.json

      - name: Notify Slack on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            STATUS="Gateway smoke test failed"
            PAYLOAD=$(jq -n --arg text "$STATUS: $GATEWAY_URL" '{text: $text}')
            curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
          else
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification"
          fi

      - name: Notify Teams on failure
        if: failure()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          GATEWAY_URL: ${{ secrets.GATEWAY_URL }}
        run: |
          if [ -n "$TEAMS_WEBHOOK_URL" ]; then
            # Simple card payload
            read -r -d '' PAYLOAD << 'EOF'
            {
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "summary": "Gateway smoke test failed",
              "themeColor": "DC3545",
              "title": "Gateway smoke test failed",
              "text": "The hourly smoke test failed for ${GATEWAY_URL}"
            }
            EOF
            curl -H 'Content-Type: application/json' -d "$PAYLOAD" "$TEAMS_WEBHOOK_URL"
          else
            echo "TEAMS_WEBHOOK_URL not set; skipping Teams notification"
          fi
