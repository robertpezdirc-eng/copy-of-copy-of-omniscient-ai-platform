name: Deploy Omni Backend to Cloud Run

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - 'cloudbuild.backend.yaml'
      - 'omni-platform/Dockerfile.backend'
  workflow_dispatch: {}

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: europe-west1
  GCP_RUN_SERVICE: omni-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and deploy via Cloud Build
        run: |
          gcloud builds submit \
            --config=cloudbuild.backend.yaml \
            --substitutions=_REGION=${{ env.GCP_REGION }},_SERVICE=${{ env.GCP_RUN_SERVICE }}

      - name: Print Cloud Run URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ env.GCP_RUN_SERVICE }} --region=${{ env.GCP_REGION }} --format='value(status.url)')
          echo "Cloud Run URL: ${URL}"
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "Cloud Run URL: ${{ steps.url.outputs.url }}" | tee cloudrun-url.txt
          echo "Use these curl checks:" >> cloudrun-url.txt
          echo "curl -s ${{ steps.url.outputs.url }}/api/health" >> cloudrun-url.txt
          echo "curl -s ${{ steps.url.outputs.url }}/api/v1/omni/summary" >> cloudrun-url.txt
          echo "curl -s ${{ steps.url.outputs.url }}/metrics | head -n 5" >> cloudrun-url.txt
          cat cloudrun-url.txt