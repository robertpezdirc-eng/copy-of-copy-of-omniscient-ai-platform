<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNI Sync Core - Device Discovery Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .device-card {
            transition: all 0.3s ease;
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected { background-color: #10B981; }
        .status-discovered { background-color: #F59E0B; }
        .status-connecting { background-color: #3B82F6; animation: pulse 1.5s infinite; }
        .status-failed { background-color: #EF4444; }
        .status-disconnected { background-color: #6B7280; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        üîç OMNI Sync Core Dashboard
                    </h1>
                    <p class="text-gray-600 mt-2">Automatic Device Discovery and Management</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Last Update</div>
                        <div id="lastUpdate" class="font-mono text-sm">Never</div>
                    </div>
                    <button id="refreshBtn" onclick="refreshData()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Devices</p>
                        <p id="totalDevices" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Connected</p>
                        <p id="connectedDevices" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-full">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Scan Cycles</p>
                        <p id="scanCycles" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Discovery Methods</p>
                        <p id="discoveryMethods" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Control Panel</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button id="startDiscoveryBtn" onclick="startDiscovery()"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 8a9 9 0 110-18 9 9 0 010 18z"></path>
                    </svg>
                    Start Discovery
                </button>

                <button id="stopDiscoveryBtn" onclick="stopDiscovery()"
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m-7 1v-3a4 4 0 118 0v3M9 21h6a2 2 0 002-2v-1a1 1 0 00-1-1H8a1 1 0 00-1 1v1a2 2 0 002 2z"></path>
                    </svg>
                    Stop Discovery
                </button>

                <button id="clearDevicesBtn" onclick="clearDevices()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Clear Devices
                </button>

                <a href="/quest3" target="_blank"
                   class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg flex items-center justify-center text-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    Quest 3 VR/AR
                </a>
            </div>
        </div>

        <!-- Device Categories -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Device Categories</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <button onclick="filterDevices('all')" class="category-btn bg-blue-100 text-blue-800 px-4 py-2 rounded-lg hover:bg-blue-200">All</button>
                <button onclick="filterDevices('vr')" class="category-btn bg-purple-100 text-purple-800 px-4 py-2 rounded-lg hover:bg-purple-200">VR</button>
                <button onclick="filterDevices('computer')" class="category-btn bg-green-100 text-green-800 px-4 py-2 rounded-lg hover:bg-green-200">Computers</button>
                <button onclick="filterDevices('mobile')" class="category-btn bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg hover:bg-yellow-200">Mobile</button>
                <button onclick="filterDevices('iot')" class="category-btn bg-pink-100 text-pink-800 px-4 py-2 rounded-lg hover:bg-pink-200">IoT</button>
                <button onclick="filterDevices('network')" class="category-btn bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-200">Network</button>
            </div>
        </div>

        <!-- Devices Grid -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Discovered Devices</h2>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Filter:</span>
                    <select id="statusFilter" onchange="filterDevicesByStatus()" class="border border-gray-300 rounded px-3 py-1 text-sm">
                        <option value="all">All Status</option>
                        <option value="connected">Connected</option>
                        <option value="discovered">Discovered</option>
                        <option value="connecting">Connecting</option>
                        <option value="failed">Failed</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                </div>
            </div>

            <div id="devicesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Devices will be populated here -->
            </div>

            <div id="noDevices" class="text-center py-12 text-gray-500" style="display: none;">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-.881-5.85-2.56A7.962 7.962 0 014 8a7.962 7.962 0 012.15-4.44A7.962 7.962 0 0112 1c2.34 0 4.29.881 5.85 2.56A7.962 7.962 0 0120 8a7.962 7.962 0 01-2.15 4.44"></path>
                </svg>
                <p>No devices discovered yet</p>
                <p class="text-sm">Start device discovery to see devices here</p>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let devicesData = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            // Auto-refresh every 10 seconds
            setInterval(refreshData, 10000);
        });

        async function refreshData() {
            try {
                // Fetch discovered devices
                const devicesResponse = await fetch('/api/devices');
                const devicesResult = await devicesResponse.json();

                // Fetch sync core stats
                const statsResponse = await fetch('/api/sync-stats');
                const statsResult = await statsResponse.json();

                // Fetch device manager stats
                const deviceManagerResponse = await fetch('/api/device-stats');
                const deviceManagerResult = await deviceManagerResponse.json();

                if (devicesResult.success) {
                    devicesData = devicesResult.devices;
                    updateDevicesGrid(devicesData);
                }

                if (statsResult.success) {
                    updateStats(statsResult.stats);
                }

                if (deviceManagerResult.success) {
                    updateDeviceManagerStats(deviceManagerResult.stats);
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalDevices').textContent = stats.active_devices || 0;
            document.getElementById('scanCycles').textContent = stats.scan_cycles || 0;

            // Count discovery methods
            const methods = new Set();
            if (stats.mdns_available) methods.add('mDNS');
            if (stats.ble_available) methods.add('BLE');
            methods.add('WiFi');
            document.getElementById('discoveryMethods').textContent = methods.size;
        }

        function updateDeviceManagerStats(stats) {
            document.getElementById('connectedDevices').textContent = stats.connected_devices || 0;
        }

        function updateDevicesGrid(devices) {
            const grid = document.getElementById('devicesGrid');
            const noDevices = document.getElementById('noDevices');

            if (!devices || devices.length === 0) {
                grid.style.display = 'none';
                noDevices.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noDevices.style.display = 'none';

            grid.innerHTML = '';

            devices.forEach(device => {
                if (currentFilter !== 'all' && device.category !== currentFilter) {
                    return;
                }

                const deviceCard = createDeviceCard(device);
                grid.appendChild(deviceCard);
            });
        }

        function createDeviceCard(device) {
            const card = document.createElement('div');
            card.className = 'device-card bg-white border border-gray-200 rounded-lg p-6';

            const statusClass = `status-indicator status-${device.connection_status}`;

            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <span class="${statusClass}"></span>
                        <h3 class="text-lg font-semibold text-gray-800">${device.device_name}</h3>
                    </div>
                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${device.category}</span>
                </div>

                <div class="space-y-2 mb-4">
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        ${device.device_type}
                    </div>

                    ${device.ip_address ? `
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 0a9 9 0 01-9-9m9 9a9 9 0 00-9 9m9-9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9h.01M12 12h4.01M12 12h4.01M12 12h4.01"></path>
                        </svg>
                        ${device.ip_address}${device.port ? ':' + device.port : ''}
                    </div>
                    ` : ''}

                    ${device.mac_address ? `
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        ${device.mac_address}
                    </div>
                    ` : ''}

                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        ${device.discovery_method.toUpperCase()}
                    </div>

                    ${device.signal_strength ? `
                    <div class="flex items-center text-sm text-gray-600">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Signal: ${device.signal_strength}%
                    </div>
                    ` : ''}
                </div>

                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-500">
                        Last seen: ${new Date(device.last_seen).toLocaleTimeString()}
                    </div>

                    <div class="flex space-x-2">
                        ${device.connection_status === 'discovered' ? `
                        <button onclick="connectDevice('${device.device_id}')"
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            Connect
                        </button>
                        ` : ''}

                        ${device.connection_status === 'connected' ? `
                        <button onclick="disconnectDevice('${device.device_id}')"
                                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Disconnect
                        </button>
                        ` : ''}

                        <button onclick="showDeviceDetails('${device.device_id}')"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            Details
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        function filterDevices(category) {
            currentFilter = category;
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === category) {
                    btn.classList.remove('bg-gray-100', 'text-gray-800');
                    btn.classList.add('bg-blue-500', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-800');
                }
            });

            updateDevicesGrid(devicesData);
        }

        function filterDevicesByStatus() {
            const statusFilter = document.getElementById('statusFilter').value;
            updateDevicesGrid(devicesData);

            if (statusFilter !== 'all') {
                const cards = document.querySelectorAll('.device-card');
                cards.forEach(card => {
                    const statusElement = card.querySelector('.status-indicator');
                    const cardStatus = Array.from(statusElement.classList).find(cls =>
                        cls.startsWith('status-')
                    ).replace('status-', '');

                    if (cardStatus !== statusFilter) {
                        card.style.display = 'none';
                    } else {
                        card.style.display = 'block';
                    }
                });
            }
        }

        async function startDiscovery() {
            try {
                const response = await fetch('/api/start-discovery', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('startDiscoveryBtn').classList.add('bg-green-600');
                    document.getElementById('stopDiscoveryBtn').classList.remove('bg-red-600');
                    setTimeout(() => document.getElementById('startDiscoveryBtn').classList.remove('bg-green-600'), 1000);
                }
            } catch (error) {
                console.error('Error starting discovery:', error);
            }
        }

        async function stopDiscovery() {
            try {
                const response = await fetch('/api/stop-discovery', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('stopDiscoveryBtn').classList.add('bg-red-600');
                    document.getElementById('startDiscoveryBtn').classList.remove('bg-green-600');
                    setTimeout(() => document.getElementById('stopDiscoveryBtn').classList.remove('bg-red-600'), 1000);
                }
            } catch (error) {
                console.error('Error stopping discovery:', error);
            }
        }

        async function connectDevice(deviceId) {
            try {
                const response = await fetch(`/api/connect-device/${deviceId}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    refreshData();
                }
            } catch (error) {
                console.error('Error connecting device:', error);
            }
        }

        async function disconnectDevice(deviceId) {
            try {
                const response = await fetch(`/api/disconnect-device/${deviceId}`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    refreshData();
                }
            } catch (error) {
                console.error('Error disconnecting device:', error);
            }
        }

        function showDeviceDetails(deviceId) {
            const device = devicesData.find(d => d.device_id === deviceId);
            if (device) {
                alert(`Device Details:\n\nName: ${device.device_name}\nType: ${device.device_type}\nIP: ${device.ip_address || 'N/A'}\nMAC: ${device.mac_address || 'N/A'}\nStatus: ${device.connection_status}\nLast Seen: ${new Date(device.last_seen).toLocaleString()}`);
            }
        }

        async function clearDevices() {
            if (confirm('Are you sure you want to clear all discovered devices?')) {
                try {
                    const response = await fetch('/api/clear-devices', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        refreshData();
                    }
                } catch (error) {
                    console.error('Error clearing devices:', error);
                }
            }
        }
    </script>
</body>
</html>