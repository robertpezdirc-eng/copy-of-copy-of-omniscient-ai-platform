name: Build AI Dashboards

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      priority:
        description: 'Dashboard priority to build (1=high, 2=medium, 3=low, all=all)'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - 'all'
      
  # Scheduled build (weekly on Monday at 2 AM UTC)
  schedule:
    - cron: '0 2 * * 1'
  
  # Trigger on backend deployment
  workflow_run:
    workflows: ["Deploy Backend"]
    types:
      - completed

env:
  GCP_PROJECT_ID: refined-graph-471712-n9
  GCP_REGION: europe-west1
  BACKEND_URL: https://omni-ultra-backend-661612368188.europe-west1.run.app

jobs:
  check-builder-health:
    name: Check Dashboard Builder Health
    runs-on: ubuntu-latest
    outputs:
      ollama_healthy: ${{ steps.status.outputs.ollama_healthy }}
      
    steps:
      - name: Check Builder Status
        id: status
        run: |
          response=$(curl -s "${{ env.BACKEND_URL }}/api/v1/dashboards/build/status")
          echo "Status Response: $response"
          
          ollama_healthy=$(echo "$response" | jq -r '.ollama_healthy')
          echo "ollama_healthy=$ollama_healthy" >> $GITHUB_OUTPUT
          
          if [ "$ollama_healthy" != "true" ]; then
            echo "âš ï¸ Ollama is not healthy - will use template fallback"
          else
            echo "âœ… Ollama is healthy"
          fi

  build-high-priority:
    name: Build High Priority Dashboards
    runs-on: ubuntu-latest
    needs: check-builder-health
    if: |
      github.event_name == 'schedule' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.priority == '1')
    
    steps:
      - name: Build Priority 1 Dashboards
        run: |
          echo "ðŸŽ¨ Building High Priority Dashboards..."
          
          response=$(curl -s -X POST "${{ env.BACKEND_URL }}/api/v1/dashboards/build" \
            -H "Content-Type: application/json" \
            -d '{
              "priority_filter": 1,
              "save_to_disk": true,
              "output_dir": "dashboards/generated"
            }')
          
          echo "$response" | jq '.'
          
          count=$(echo "$response" | jq -r '.count')
          echo "âœ… Built $count dashboards"
          
      - name: List Generated Files
        run: |
          response=$(curl -s "${{ env.BACKEND_URL }}/api/v1/dashboards/generated")
          echo "$response" | jq -r '.dashboards[] | "- \(.name): \(.file)"'

  build-medium-priority:
    name: Build Medium Priority Dashboards
    runs-on: ubuntu-latest
    needs: check-builder-health
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.priority == '2'
    
    steps:
      - name: Build Priority 2 Dashboards
        run: |
          echo "ðŸŽ¨ Building Medium Priority Dashboards..."
          
          response=$(curl -s -X POST "${{ env.BACKEND_URL }}/api/v1/dashboards/build" \
            -H "Content-Type: application/json" \
            -d '{
              "priority_filter": 2,
              "save_to_disk": true
            }')
          
          echo "$response" | jq '.'
          count=$(echo "$response" | jq -r '.count')
          echo "âœ… Built $count dashboards"

  build-low-priority:
    name: Build Low Priority Dashboards
    runs-on: ubuntu-latest
    needs: check-builder-health
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.priority == '3'
    
    steps:
      - name: Build Priority 3 Dashboards
        run: |
          echo "ðŸŽ¨ Building Low Priority Dashboards..."
          
          response=$(curl -s -X POST "${{ env.BACKEND_URL }}/api/v1/dashboards/build" \
            -H "Content-Type: application/json" \
            -d '{
              "priority_filter": 3,
              "save_to_disk": true
            }')
          
          echo "$response" | jq '.'
          count=$(echo "$response" | jq -r '.count')
          echo "âœ… Built $count dashboards"

  build-all-dashboards:
    name: Build All Dashboards
    runs-on: ubuntu-latest
    needs: check-builder-health
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.priority == 'all'
    
    steps:
      - name: Build All 20 Dashboards
        run: |
          echo "ðŸŽ¨ Building ALL Dashboards (20 total)..."
          echo "âš ï¸ This will take 10-20 minutes..."
          
          response=$(curl -s -X POST "${{ env.BACKEND_URL }}/api/v1/dashboards/build" \
            -H "Content-Type: application/json" \
            -d '{
              "save_to_disk": true,
              "output_dir": "dashboards/generated"
            }')
          
          echo "$response" | jq '.'
          
          count=$(echo "$response" | jq -r '.count')
          success_count=$(echo "$response" | jq '[.dashboards[] | select(.success == true)] | length')
          
          echo "âœ… Built $success_count/$count dashboards successfully"
          
      - name: List All Generated Files
        run: |
          response=$(curl -s "${{ env.BACKEND_URL }}/api/v1/dashboards/generated")
          
          echo "ðŸ“Š Generated Dashboards:"
          echo "$response" | jq -r '.dashboards[] | "- \(.name) (\(.priority)) â†’ \(.file)"'

  verify-dashboards:
    name: Verify Dashboard Quality
    runs-on: ubuntu-latest
    needs: 
      - build-high-priority
      - build-medium-priority
      - build-low-priority
      - build-all-dashboards
    if: always()
    
    steps:
      - name: Get Generated Dashboards
        id: dashboards
        run: |
          response=$(curl -s "${{ env.BACKEND_URL }}/api/v1/dashboards/generated")
          echo "$response" > dashboards.json
          cat dashboards.json | jq '.'
          
      - name: Check Dashboard Count
        run: |
          count=$(jq -r '.dashboards | length' dashboards.json)
          echo "Total generated dashboards: $count"
          
          if [ "$count" -eq 0 ]; then
            echo "âš ï¸ No dashboards generated"
            exit 1
          fi
          
      - name: Validate Manifest
        run: |
          manifest_path=$(jq -r '.manifest_path' dashboards.json)
          echo "Manifest location: $manifest_path"
          
      - name: Dashboard Summary
        run: |
          echo "### ðŸ“Š Dashboard Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | Priority | File |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|------|" >> $GITHUB_STEP_SUMMARY
          
          jq -r '.dashboards[] | "| \(.name) | \(.priority) | `\(.file)` |"' dashboards.json >> $GITHUB_STEP_SUMMARY

  deploy-to-frontend:
    name: Deploy Dashboards to Frontend
    runs-on: ubuntu-latest
    needs: verify-dashboards
    if: success()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Download Generated Dashboards
        run: |
          # In production, this would download from Cloud Storage
          # For now, dashboards are stored in backend container
          echo "ðŸ“¦ Dashboards are stored in backend container"
          echo "To integrate into frontend:"
          echo "1. Access backend container file system"
          echo "2. Copy dashboards/generated/*.tsx to frontend/src/pages/dashboards/"
          echo "3. Update frontend routes"
          
      - name: Create Frontend PR
        run: |
          # In production, this would create a PR with new dashboards
          echo "ðŸš€ Would create PR to integrate new dashboards into frontend"
          echo "Files to add: backend/dashboards/generated/*.tsx"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: 
      - verify-dashboards
      - deploy-to-frontend
    if: always()
    
    steps:
      - name: Build Status Summary
        run: |
          echo "### ðŸŽ¨ Dashboard Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Backend URL:** ${{ env.BACKEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**Priority Filter:** ${{ github.event.inputs.priority }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View generated dashboards: ${{ env.BACKEND_URL }}/api/v1/dashboards/generated" >> $GITHUB_STEP_SUMMARY
